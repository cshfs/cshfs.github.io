<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DOSBox — Editor + Run (Simple)</title>

<!-- js-dos (local) -->
<link rel="stylesheet" href="js-dos.css" />
<script src="js-dos.js"></script>

<!-- CodeMirror 5 (local) -->
<link rel="stylesheet" href="codemirror.min.css">
<script src="codemirror.min.js"></script>
<script src="tasm.js"></script>

<style>
  :root{
    --ctl-h: 30px;
    --ctl-font: 13px;
  }

  * { box-sizing: border-box; }

  /* Keep scrollbar stable to avoid horizontal/vertical "jumps" */
  html { overflow-y: scroll; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#fff;
    color:#000;
    overflow-x:hidden; /* hard stop for any accidental horizontal overflow */
  }

  main{
    width:min(1280px, 96vw);
    margin:0 auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }

  .btn, .inp{
    font: inherit;
    font-size: var(--ctl-font);
    height: var(--ctl-h);
    border:2px solid #000;
    border-radius:0;
    background:#fff;
    color:#000;
    padding:0 10px;
  }

  .btn{
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .btn:hover{ background:#f4f4f4; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }

  #fileName{ width:260px; }

  label.file{ position:relative; }
  label.file input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

  /* Editor sizing: CSS-only, no JS sizing */
  .CodeMirror{
    width:100%;
    height: clamp(260px, 45vh, 700px);
    border:2px solid #000;
  }
  .CodeMirror-gutters{ border-right:2px solid #000; }

  /* DOSBox: always visible, CSS-only sizing */
  #dosbox{
    width:100%;
    height: clamp(260px, 45vh, 720px);
    border:2px solid #000;
    overflow:hidden;          /* prevents any internal overflow from showing */
    background:#fff;
  }

  /* Make js-dos wrappers fill the container and not add visual offsets */
  :where(.dosbox-root,.dosbox-container,.dosbox-viewport,.dosbox){
    width:100% !important;
    height:100% !important;
    margin:0 !important;
    padding:0 !important;
    background:#fff !important;
    box-shadow:none !important;
    border:none !important;
  }
  #dosbox canvas{
    width:100% !important;
    height:100% !important;
    display:block;
    background:#000 !important;
  }

  #statusLine{
    font-size: 12px;
    color:#333;
  }

  .locked .CodeMirror{ opacity:.55; pointer-events:none; }
</style>

<script>
/* COOP/COEP SW (keep if you rely on crossOriginIsolated) */
(function () {
  if (!('serviceWorker' in navigator)) return;
  const swUrl = new URL('./coi-sw.js', location.href);
  navigator.serviceWorker.register(swUrl, { scope: './' }).catch(()=>{});
})();
</script>
</head>

<body>
<main>
  <div class="row">
    <input id="fileName" class="inp" type="text" value="base.asm" aria-label="File name">
    <button id="newBtn" class="btn" type="button">New</button>
    <button id="saveLocalBtn" class="btn" type="button">Save (local)</button>
    <button id="downloadBtn" class="btn" type="button">Download .ASM</button>
    <button id="loadBtn" class="btn" type="button">Load .ASM</button>
    <input id="loader" type="file" accept=".asm,.inc,.txt" style="display:none" />
    <label class="file btn">Choose asset files<input id="assetInput" type="file" multiple /></label>

    <button id="startBtn" class="btn" type="button" disabled>Start</button>
    <button id="stopBtn" class="btn" type="button">Stop</button>
  </div>

  <div id="statusLine">Loading tools…</div>

  <textarea id="editorTA">IDEAL
MODEL small
STACK 100h
DATASEG
; --------------------------
; Your variables here
; --------------------------
msg db 'Hello!$'

CODESEG
start:
  mov ax, @data
  mov ds, ax
; --------------------------
; Your code here
; --------------------------
  mov dx, OFFSET msg
  mov ah, 09h
  int 21h

exit:
  mov ax, 4c00h
  int 21h
END start
</textarea>

  <div id="dosbox" aria-label="DOSBox frame"></div>
</main>

<script>
(function(){
  /* ===== Simple persistence ===== */
  const LS_NAME = 'dos_simple_name_v1';
  const LS_TEXT = 'dos_simple_text_v1';

  const DEFAULT_NAME = 'base.asm';
  const DEFAULT_TEXT =
`IDEAL
MODEL small
STACK 100h
DATASEG
; --------------------------
; Your variables here
; --------------------------


CODESEG
start:
  mov ax, @data
  mov ds, ax
; --------------------------
; Your code here
; --------------------------

exit:
  mov ax, 4c00h
  int 21h
END start
`;

  const fileNameEl  = document.getElementById('fileName');
  const statusLine  = document.getElementById('statusLine');
  const startBtn    = document.getElementById('startBtn');
  const stopBtn     = document.getElementById('stopBtn');
  const newBtn      = document.getElementById('newBtn');
  const saveLocalBtn= document.getElementById('saveLocalBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const loadBtn     = document.getElementById('loadBtn');
  const loader      = document.getElementById('loader');
  const assetInput  = document.getElementById('assetInput');
  const mainEl      = document.querySelector('main');

  const cm = CodeMirror.fromTextArea(document.getElementById('editorTA'), {
    lineNumbers: true,
    mode: 'tasm',
    indentUnit: 2,
    tabSize: 2
  });

  function persist(){
    localStorage.setItem(LS_NAME, fileNameEl.value || DEFAULT_NAME);
    localStorage.setItem(LS_TEXT, cm.getValue());
  }

  // restore
  fileNameEl.value = localStorage.getItem(LS_NAME) || DEFAULT_NAME;
  const savedText = localStorage.getItem(LS_TEXT);
  if (savedText) cm.setValue(savedText);

  fileNameEl.addEventListener('input', persist);
  cm.on('change', () => { clearTimeout(persist._t); persist._t = setTimeout(persist, 120); });

  /* ===== Files/assets ===== */
  const encoder = new TextEncoder();
  const bag = new Map(); // extra assets: name -> File

  function toDos83(name){
    const i = name.lastIndexOf('.');
    let b = (i>=0?name.slice(0,i):name).toUpperCase();
    let e = (i>=0?name.slice(i+1):'').toUpperCase();
    const clean = s=>s.replace(/[^A-Z0-9]/g,'_');
    b = clean(b).slice(0,8);
    e = clean(e).slice(0,3);
    return e ? `${b}.${e}` : b;
  }

  function buildBatFor(dosAsmName){
    const base = dosAsmName.replace(/\.[^.]*$/,'');
    const lines = [
      '@echo off',
      'echo Assembling ' + dosAsmName,
      'TASM /zi /q ' + dosAsmName,
      'if errorlevel 1 goto ERR',
      'echo Linking ' + base + '.OBJ',
      'TLINK /v ' + base + '.OBJ,,NUL,;',
      'if errorlevel 1 goto ERR',
      'echo Running ' + base + '.EXE',
      base + '.EXE',
      'echo.',
      'goto END',
      ':ERR',
      'echo Build failed.',
      ':END'
    ];
    return encoder.encode(lines.join("\r\n") + "\r\n");
  }

  /* ===== js-dos start/stop ===== */
  const dosboxEl = document.getElementById('dosbox');
  let player = null;

  const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
cls
BUILD
`;

  function stopDos(){
    if (player && typeof player.exit === 'function') {
      try { player.exit(); } catch {}
    }
    player = null;
    dosboxEl.innerHTML = '';
    mainEl.classList.remove('locked');
    cm.setOption('readOnly', false);
    startBtn.disabled = false;
    statusLine.textContent = 'Stopped.';
  }

  stopBtn.addEventListener('click', stopDos);

  /* ===== UI actions ===== */
  newBtn.addEventListener('click', ()=>{
    fileNameEl.value = DEFAULT_NAME;
    cm.setValue(DEFAULT_TEXT);
    cm.focus();
    persist();
  });

  saveLocalBtn.addEventListener('click', ()=>{
    persist();
    statusLine.textContent = 'Saved locally.';
  });

  downloadBtn.addEventListener('click', ()=>{
    const name = (fileNameEl.value || DEFAULT_NAME);
    const content = cm.getValue();
    const blob = new Blob([content], { type:'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name.toUpperCase();
    a.click();
    URL.revokeObjectURL(a.href);
    persist();
    statusLine.textContent = 'Downloaded.';
  });

  loadBtn.addEventListener('click', ()=> loader.click());
  loader.addEventListener('change', async ()=>{
    const f = loader.files && loader.files[0];
    if (!f) return;
    const text = await f.text();
    cm.setValue(text);
    fileNameEl.value = f.name;
    loader.value = '';
    cm.focus();
    persist();
    statusLine.textContent = 'Loaded file.';
  });

  assetInput.addEventListener('change', ()=>{
    for (const f of Array.from(assetInput.files || [])) bag.set(f.name, f);
    assetInput.value = '';
    statusLine.textContent = `Assets: ${bag.size}`;
  });

  /* ===== Tool preload (simple) ===== */
  let toolBufs = new Map(); // filename -> Uint8Array

  async function fetchBin(url){
    const resp = await fetch(url, { cache:'reload' });
    if (!resp.ok) throw new Error('Failed: ' + url);
    return new Uint8Array(await resp.arrayBuffer());
  }

  async function preloadTools(){
    // Keep this minimal and explicit.
    const list = [
      ['TASM.EXE',  'tools/TASM.EXE'],
      ['TLINK.EXE', 'tools/TLINK.EXE'],
      // optional (only if you use them)
      ['DPMI16BI.OVL','tools/DPMI16BI.OVL'],
      ['RTM.EXE',     'tools/RTM.EXE'],
      ['TD.EXE',      'tools/TD.EXE'],
      ['TDCONFIG.TD', 'tools/TDCONFIG.TD'],
    ];

    statusLine.textContent = 'Loading tools…';
    const loaded = new Map();

    // Required first
    for (const [name, url] of list.slice(0,2)) {
      loaded.set(name, await fetchBin(url));
    }

    // Optional best-effort
    for (const [name, url] of list.slice(2)) {
      try { loaded.set(name, await fetchBin(url)); } catch {}
    }

    toolBufs = loaded;
    startBtn.disabled = false;
    statusLine.textContent = 'Ready.';
  }

  startBtn.addEventListener('click', async ()=>{
    try {
      persist();

      mainEl.classList.add('locked');
      cm.setOption('readOnly', true);
      startBtn.disabled = true;

      const name = fileNameEl.value || DEFAULT_NAME;
      const content = cm.getValue();

      const dosAsmName = toDos83(name);
      const asmBytes = encoder.encode(content);

      const initFs = [
        { path:'TASM.EXE',  contents: toolBufs.get('TASM.EXE') },
        { path:'TLINK.EXE', contents: toolBufs.get('TLINK.EXE') },
        { path: dosAsmName, contents: asmBytes },
        { path:'BUILD.BAT', contents: buildBatFor(dosAsmName) },
      ];

      for (const opt of ['DPMI16BI.OVL','RTM.EXE','TD.EXE','TDCONFIG.TD']) {
        const buf = toolBufs.get(opt);
        if (buf) initFs.push({ path: opt, contents: buf });
      }

      for (const f of Array.from(bag.values())) {
        initFs.push({ path: toDos83(f.name), contents: new Uint8Array(await f.arrayBuffer()) });
      }

      // restart DOS cleanly
      if (player && typeof player.exit === 'function') { try { player.exit(); } catch {} }
      dosboxEl.innerHTML = '';

      player = window.Dos(dosboxEl, {
        pathPrefix: "emulators/",
        dosboxConf: DOS_CONF,
        initFs,
        noCloud: true,
        noNetworking: true,
        kiosk: true,
        autostart: true
      });

      statusLine.textContent = 'Running…';

    } catch (e) {
      console.error(e);
      statusLine.textContent = 'Start failed (see console).';
      mainEl.classList.remove('locked');
      cm.setOption('readOnly', false);
      startBtn.disabled = false;
    }
  });

  preloadTools().catch(e=>{
    console.error(e);
    statusLine.textContent = 'Tool preload failed (see console).';
  });

})();
</script>
</body>
</html>
