<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DOSBox Emulator</title>

  <!-- Local js-dos UMD build (global window.Dos) -->
  <link rel="stylesheet" href="js-dos.css" />
  <script src="js-dos.js"></script>

  <style>
    :root {
      /* Theme */
      --bg1: #0f172a;
      --bg2: #111827;
      --text: #e5e7eb;
      --accent: #86efac;
      --accent2:#22c55e;
      --border: rgba(255,255,255,0.08);
      --ring:   rgba(34,197,94,0.25);

      /* Desktop max frame size target (kept for aspect) */
      --frame-w: 1050;
      --frame-h: 600;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 700px at 50% -10%, #1f2937 0%, var(--bg1) 45%, var(--bg2) 100%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .shell {
      width: 100%;
      max-width: calc(var(--frame-w) * 1px + 64px);
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: .2px;
    }
    .title h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 650;
      color: #f8fafc;
      text-shadow: 0 1px 0 rgba(0,0,0,.4);
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow:
        0 1px 0 rgba(255,255,255,0.03) inset,
        0 10px 30px rgba(0,0,0,0.25),
        0 0 0 1px rgba(255,255,255,0.02);
      width: 100%;
      max-width: calc(var(--frame-w) * 1px + 32px);
      padding: 16px;
      display: grid;
      justify-items: center;
      gap: 14px;
      margin: 0 auto;
    }

    /* Fluid DOS frame: fills width, keeps 1050:600, scales nicely */
    #dosbox {
      width: 100%;
      max-width: calc(var(--frame-w) * 1px);
      aspect-ratio: calc(var(--frame-w) / var(--frame-h));
      border: 1px solid var(--border);
      background: #000;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.03) inset,
        0 0 0 2px rgba(134,239,172,0.06),
        0 20px 50px rgba(0,0,0,.45);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
      justify-content: center;
    }

    /* Buttons */
    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
    }
    .btn[disabled] { opacity: .55; cursor: not-allowed; }
    .btn:hover:not([disabled]) { border-color: rgba(134,239,172,0.35); box-shadow: 0 0 0 4px var(--ring); }

    /* Always-visible file button */
    .file {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      color: #e5e7eb;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset;
      transition: transform .02s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .file:hover { border-color: rgba(134,239,172,0.35); box-shadow: 0 0 0 4px var(--ring); }
    .file input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
    }
    .file .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #cbd5e1;
    }
    .file .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 10px var(--ring);
    }

    /* Uploaded files list */
    ul.files {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
      width: 100%;
      max-width: calc(var(--frame-w) * 1px);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: #cbd5e1;
    }
    ul.files li {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.06);
    }
    .hidden { display: none !important; }

    .brandline {
      height: 1px;
      width: 100%;
      background: linear-gradient(90deg, transparent, rgba(134,239,172,0.65), transparent);
      margin-top: 8px;
      opacity: .7;
    }

    /* Drag-and-drop zone (desktop only) */
    .drop {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 16px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      transition: box-shadow .2s ease, border-color .2s ease;
      text-align: center;
    }
    .drop.dragover { border-color: rgba(134,239,172,0.55); box-shadow: 0 0 0 6px var(--ring); }

    /* --- Mobile tweaks --- */
    @media (max-width: 600px) {
      .shell { padding: 12px; }
      .title h1 { font-size: 18px; }
      .btn, .file .badge { font-size: 15px; }
      ul.files { font-size: 11px; }
      /* Big, obvious upload button on phones */
      .file { width: 100%; justify-content: center; }
      .btn#startBtn { width: 100%; }
    }
    /* Hide DnD on touch devices (keep file button visible) */
    @media (hover: none) and (pointer: coarse) {
      .drop { display: none; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="title">
        <h1>DOSBox Emulator</h1>
      </div>
      <button id="resetBtn" class="btn" title="Reset and choose new files">Reset</button>
    </header>

    <section class="card">
      <div id="dosbox" aria-label="DOSBox frame"></div>

      <div class="controls" id="controls">
        <!-- Always visible on all devices -->
        <label class="file" aria-label="Choose files to upload">
          <span class="badge"><span class="dot"></span>Choose files</span>
          <input id="fileInput" type="file" multiple />
        </label>

        <!-- Extra drag-and-drop zone, auto-hidden on touch -->
        <div id="dropZone" class="drop" aria-label="Drop files here">Drag & drop files here</div>

        <button id="startBtn" class="btn" disabled title="Start after adding exactly one .asm">Start</button>
      </div>

      <ul id="fileList" class="files hidden" aria-label="Selected files"></ul>
    </section>

    <div class="brandline"></div>
  </div>

  <script>
    (function () {
      const DosGlobal = window.Dos;
      if (!DosGlobal) { alert("js-dos.js not found/loaded. Make sure js-dos.js is next to this HTML."); return; }

      const elDos    = document.getElementById('dosbox');
      const elInput  = document.getElementById('fileInput');
      const elFiles  = document.getElementById('fileList');
      const elCtrl   = document.getElementById('controls');
      const elReset  = document.getElementById('resetBtn');
      const elDrop   = document.getElementById('dropZone');
      const elStart  = document.getElementById('startBtn');

      const encoder = new TextEncoder();
      let currentPlayer = null;

      // ---------- Helpers ----------
      function toDos83(name) {
        const idx = name.lastIndexOf('.');
        let base = (idx >= 0 ? name.slice(0, idx) : name).toUpperCase();
        let ext  = (idx >= 0 ? name.slice(idx + 1) : '').toUpperCase();
        const clean = s => s.replace(/[^A-Z0-9]/g, '_');
        base = clean(base).slice(0, 8);
        ext  = clean(ext).slice(0, 3);
        return ext ? `${base}.${ext}` : base;
      }
      function isAsm(name){
        if (!name) return false;
        let n = String(name).toLowerCase().trim().replace(/[\.]+$/,'');
        return n.endsWith('.asm');
      }

      // ---------- Tool buffers ----------
      let tasmBuf=null, tlinkBuf=null, dpmiBuf=null, rtmBuf=null, tdBuf=null, tdCfgBuf=null;
      async function preloadTools(){
        const get = async (path, opt=false) => {
          const r = await fetch(path);
          if (!r.ok) { if (opt) return null; throw new Error(path + ' not found'); }
          return new Uint8Array(await r.arrayBuffer());
        };
        [tasmBuf, tlinkBuf, dpmiBuf, rtmBuf, tdBuf, tdCfgBuf] = await Promise.all([
          get('tools/TASM.EXE'),
          get('tools/TLINK.EXE'),
          get('tools/DPMI16BI.OVL', true),
          get('tools/RTM.EXE',     true),
          get('tools/TD.EXE',      true),
          get('tools/TDCONFIG.TD', true)
        ]);
      }

      // ---------- DOS config (auto-runs BUILD.BAT) ----------
      const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
cls
BUILD
`;

      function buildBatFor(dosAsmName){
        const base = dosAsmName.replace(/\.[^.]*$/, '');
        const lines = [
          '@echo off',
          'TASM /zi /q ' + dosAsmName + ' > BUILD.LOG',
          'if errorlevel 1 goto ERR',
          'TLINK /v ' + base + '.OBJ,,NUL,; >> BUILD.LOG',
          'if errorlevel 1 goto ERR',
          base + '.EXE',
          'echo.',
          'goto END',
          ':ERR',
          'type BUILD.LOG',
          ':END'
        ];
        return encoder.encode(lines.join("\r\n") + "\r\n");
      }

      function startDosWith(initFs){
        if (currentPlayer && typeof currentPlayer.exit === 'function') {
          try { currentPlayer.exit(); } catch {}
        }
        elDos.innerHTML = '';
        currentPlayer = DosGlobal(elDos, {
          pathPrefix: "emulators/",
          dosboxConf: DOS_CONF,
          initFs,
          noCloud: true,
          noNetworking: true,
          kiosk: true,
          autostart: true
        });
      }

      // ===== Accumulate selections without Ctrl/Cmd =====
      const bag = new Map(); // name -> File
      function countAsm(iterable) { let c=0; for (const f of iterable) if (isAsm(f.name)) c++; return c; }

      function addFiles(list) {
        const incoming = Array.from(list || []);
        const existingAsm = countAsm(bag.values());
        let toAddAsm = 0;
        for (const f of incoming) if (isAsm(f.name)) toAddAsm++;
        if (existingAsm + toAddAsm > 1) {
          alert('Select exactly ONE .asm file (you can add assets too). Extra .asm files were ignored.');
        }
        for (const f of incoming) {
          if (isAsm(f.name) && existingAsm >= 1) continue; // ignore extra .asm
          bag.set(f.name, f); // overwrite by name if re-added
        }
        refreshFilesListAndButtons();
      }

      function refreshFilesListAndButtons(){
        const files = Array.from(bag.values());
        elFiles.innerHTML = '';
        for (const f of files) {
          const li = document.createElement('li');
          li.textContent = `${f.name}  â†’  ${toDos83(f.name)}`;
          elFiles.appendChild(li);
        }
        if (files.length) elFiles.classList.remove('hidden');
        elStart.disabled = (countAsm(files) !== 1);
      }

      async function bagToInitFs(){
        const files = Array.from(bag.values());
        const asmFiles = files.filter(f => isAsm(f.name));
        if (asmFiles.length !== 1) {
          if (asmFiles.length === 0) alert('Add at least one .asm file.');
          else alert('Keep exactly ONE .asm file.');
          throw new Error('Invalid ASM selection');
        }

        if (!tasmBuf || !tlinkBuf) await preloadTools();

        const asmOriginalName = asmFiles[0].name;
        const dosAsmName = toDos83(asmOriginalName);
        const asmText = await asmFiles[0].text();

        const initFs = [
          { path: 'TASM.EXE',  contents: tasmBuf },
          { path: 'TLINK.EXE', contents: tlinkBuf },
          { path: dosAsmName,  contents: encoder.encode(asmText) },
          { path: 'BUILD.BAT', contents: buildBatFor(dosAsmName) }
        ];
        if (dpmiBuf)  initFs.push({ path: 'DPMI16BI.OVL', contents: dpmiBuf });
        if (rtmBuf)   initFs.push({ path: 'RTM.EXE',      contents: rtmBuf  });
        if (tdBuf)    initFs.push({ path: 'TD.EXE',       contents: tdBuf   });
        if (tdCfgBuf) initFs.push({ path: 'TDCONFIG.TD',  contents: tdCfgBuf});

        for (const f of files) {
          if (f === asmFiles[0]) continue;
          const dos = toDos83(f.name);
          const buf = new Uint8Array(await f.arrayBuffer());
          initFs.push({ path: dos, contents: buf });
        }
        return initFs;
      }

      // ===== Drag & drop + multi-batch picking =====
      elInput.addEventListener('change', () => { addFiles(elInput.files); elInput.value = ''; });

      // Prevent browser from opening files on accidental outside-drop
      window.addEventListener('dragover', e => e.preventDefault());
      window.addEventListener('drop',     e => e.preventDefault());

      if (elDrop) {
        ['dragenter','dragover'].forEach(evt =>
          elDrop.addEventListener(evt, e => { e.preventDefault(); elDrop.classList.add('dragover'); })
        );
        ['dragleave','drop'].forEach(evt =>
          elDrop.addEventListener(evt, e => { e.preventDefault(); elDrop.classList.remove('dragover'); })
        );
        elDrop.addEventListener('drop', e => {
          const dt = e.dataTransfer;
          if (dt?.items) {
            const files = [];
            for (const item of dt.items) {
              if (item.kind === 'file') {
                const f = item.getAsFile();
                if (f) files.push(f);
              }
            }
            addFiles(files);
          } else if (dt?.files) {
            addFiles(dt.files);
          }
        });
      }

      // ===== Start =====
      elStart.addEventListener('click', async () => {
        try {
          const initFs = await bagToInitFs();
          elCtrl.classList.add('hidden');
          startDosWith(initFs);
        } catch (e) { console.error(e); }
      });

      // ===== Reset =====
      elReset.addEventListener('click', () => { location.reload(); });
    })();
  </script>
</body>
</html>

