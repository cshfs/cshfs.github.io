<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DOSBox — Editor + Run</title>

<!-- js-dos (local) -->
<link rel="stylesheet" href="js-dos.css" />
<script src="js-dos.js"></script>

<!-- CodeMirror 5 (switch to your local files if you self-hosted) -->
<link rel="stylesheet" href="codemirror.min.css">
<script src="codemirror.min.js"></script>
<script src="gas.min.js"></script>

<style>
  /* Pure white everywhere */
  html, body { height: 100%; background:#fff; }
  body {
    margin: 0; background:#fff; color:#000;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  main { width: 100%; max-width: 980px; margin: 0 auto; padding: 12px; background:#fff; }
  section { margin: 12px 0; background:#fff; }
  h1 { display:none; } /* titles removed */

  /* Loading strip */
  #loading { padding: 8px 0; background:#fff; }
  #status { font-size: 14px; margin: 6px 0; }
  progress { width: 260px; height: 12px; vertical-align: middle; }

  /* Workspace fills the full viewport height */
  #workspace {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Controls (high contrast) */
  .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .btn {
    font: inherit; padding: 10px 14px;
    background:#111; color:#fff; border:2px solid #111; cursor:pointer;
  }
  .btn:hover { background:#000; border-color:#000; }
  .btn[disabled], .btn.disabled { opacity:.55; cursor:not-allowed; }
  input[type="text"] {
    font: inherit; padding: 8px; border:2px solid #111; width: 240px; background:#fff; color:#000;
  }
  label.file { position: relative; }
  label.file input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

  /* Editor grows to fill remaining viewport in the workspace */
  .editor-wrap { flex: 1; min-height: 0; display: flex; }
  .CodeMirror {
    height: 100%; width: 100%;
    border:2px solid #111; background:#fff; color:#000;
    transition: opacity .15s ease;
  }
  .CodeMirror-focused { outline: 2px solid #1115; }
  .cm-locked .CodeMirror { opacity: .5; pointer-events: none; }

  /* DOSBox section */
  #dosbox { width: 100%; aspect-ratio: 1050/600; background:#000; border:2px solid #111; }
  ul { margin: 6px 0 0 18px; padding: 0; background:#fff; }

  /* Force js-dos wrappers to white */
  html, body, main, section { background:#fff !important; }
  #dosbox *, .dosbox, .dosbox-root, .dosbox-container, .dosbox-viewport,
  .dosbox-overlay, .dosbox-loader { background:#fff !important; box-shadow:none !important; border-color:#fff !important; }
  #dosbox canvas { background:#000 !important; }
</style>

<script>
/* Service worker for COOP/COEP on GitHub Pages */
(function registerCOI() {
  if (!('serviceWorker' in navigator)) return;
  const swUrl = new URL('./coi-sw.js', location.href);
  const KEY = 'coi-reloaded-once';
  navigator.serviceWorker.register(swUrl, { scope: './' }).then(async () => {
    if (!navigator.serviceWorker.controller && !sessionStorage.getItem(KEY)) {
      try { await navigator.serviceWorker.ready; sessionStorage.setItem(KEY,'1'); location.reload(); } catch {}
    }
  });
  navigator.serviceWorker.addEventListener('controllerchange', () => { sessionStorage.removeItem(KEY); });
})();
</script>
</head>
<body>
<main>
  <!-- Loading -->
  <section id="loading">
    <div id="status">Preparing emulator…</div>
    <progress id="prog" value="0" max="100"></progress>
    <span id="progText"></span>
    <div id="coiNote" style="font-size:13px;color:#333;"></div>
  </section>

  <!-- Full-height workspace: controls + editor + top buttons (including assets/start/stop) -->
  <section id="workspace">
    <div class="row">
      <input id="fileName" type="text" value="HELLO.ASM" aria-label="File name">
      <button id="saveBtn" class="btn" type="button">Download .ASM</button>
      <button id="loadBtn" class="btn" type="button">Load .ASM</button>
      <input id="loader" type="file" accept=".asm,.inc,.txt" style="display:none" />
    </div>

    <div class="editor-wrap">
      <textarea id="editorTA">; 16-bit DOS example for TASM/TLINK
.MODEL  small
.STACK  100h
.DATA
msg db 'Hello from editor!$'
.CODE
main PROC
  mov ax, @data
  mov ds, ax
  mov dx, OFFSET msg
  mov ah, 09h
  int 21h
  mov ax, 4C00h
  int 21h
main ENDP
END main
</textarea>
    </div>

    <div class="row" id="topControls">
      <label class="file btn">Choose asset files<input id="fileInput" type="file" multiple /></label>
      <button id="startBtn" class="btn" type="button" disabled>Start</button>
      <button id="stopBtn" class="btn" type="button">Stop</button>
    </div>
  </section>

  <!-- DOSBox area (below the fold) -->
  <section id="emuSection">
    <div id="dosbox" aria-label="DOSBox frame"></div>
    <ul id="fileList"></ul>
  </section>
</main>

<script>
(function(){
  // ----- persistence keys -----
  const LS_KEY_NAME = 'dos_editor_name_v1';
  const LS_KEY_TEXT = 'dos_editor_text_v1';

  // ----- CodeMirror -----
  const workspace = document.getElementById('workspace');
  const cm = CodeMirror.fromTextArea(document.getElementById('editorTA'), {
    lineNumbers: true, mode: 'text/x-gas', indentUnit: 2, tabSize: 2, indentWithTabs: false, readOnly: false,
  });
  setTimeout(()=>{ cm.refresh(); }, 0);

  // Elements
  const status = document.getElementById('status');
  const prog = document.getElementById('prog');
  const progText = document.getElementById('progText');
  const loadingBox = document.getElementById('loading');
  const coiNote = document.getElementById('coiNote');

  const fileNameEl = document.getElementById('fileName');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const loader = document.getElementById('loader');

  const elDos = document.getElementById('dosbox');
  const emuSection = document.getElementById('emuSection');
  const elInput = document.getElementById('fileInput');
  const elList = document.getElementById('fileList');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  // State
  const encoder = new TextEncoder();
  const CACHE_NAME = 'dosbox-prewarm-v10'; /* keep in sync with SW if you bumped it */
  let toolBufs = new Map();
  let player = null;
  let ready = false;
  const bag = new Map(); // asset files

  // Load persisted editor state (if any)
  const savedName = localStorage.getItem(LS_KEY_NAME);
  const savedText = localStorage.getItem(LS_KEY_TEXT);
  if (savedName) fileNameEl.value = savedName;
  if (savedText) cm.setValue(savedText);

  // Helpers
  const toDos83 = (name)=>{
    const i = name.lastIndexOf('.');
    let b = (i>=0?name.slice(0,i):name).toUpperCase();
    let e = (i>=0?name.slice(i+1):'').toUpperCase();
    const clean = s=>s.replace(/[^A-Z0-9]/g,'_');
    b = clean(b).slice(0,8); e = clean(e).slice(0,3);
    return e?`${b}.${e}`:b;
  };

  const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
cls
BUILD
`;

  function buildBatFor(dosAsmName){
    const base = dosAsmName.replace(/\.[^.]*$/,'');
    const lines = [
      '@echo off',
      'echo Assembling ' + dosAsmName,
      'TASM /zi /q ' + dosAsmName,
      'if errorlevel 1 goto ERR',
      'echo Linking ' + base + '.OBJ',
      'TLINK /v ' + base + '.OBJ,,NUL,;',
      'if errorlevel 1 goto ERR',
      'echo Running ' + base + '.EXE',
      base + '.EXE',
      'echo.',
      'goto END',
      ':ERR',
      'echo Build failed.',
      ':END'
    ];
    return encoder.encode(lines.join("\r\n") + "\r\n"); // CRLF
  }

  function startDosWith(initFs){
    if (player && typeof player.exit === 'function') { try { player.exit(); } catch {} }
    elDos.innerHTML = '';
    player = window.Dos(elDos, {
      pathPrefix: "emulators/",
      dosboxConf: DOS_CONF,
      initFs,
      noCloud: true,
      noNetworking: true,
      kiosk: true,
      autostart: true
    });
  }

  async function waitForCOIController(timeoutMs=8000){
    const t0 = performance.now();
    while (performance.now() - t0 < timeoutMs) {
      if (navigator.serviceWorker?.controller && self.crossOriginIsolated) return;
      await new Promise(r=>setTimeout(r,120));
    }
    coiNote.textContent = 'Note: page is not cross-origin isolated yet. If Start fails, hard-refresh once.';
  }

  function refreshFileList(){
    const files = Array.from(bag.values());
    elList.innerHTML = '';
    for (const f of files) {
      const li = document.createElement('li');
      li.textContent = `${f.name} → ${toDos83(f.name)}`;
      elList.appendChild(li);
    }
  }

  // Preload emulator + tools (file-count progress); hide strip when ready
  async function preloadAll(){
    status.textContent = 'Caching emulator and tools…';
    const files = [
      { path:'emulators/wdosbox.wasm', url:'emulators/wdosbox.wasm', required:true,  keepInMemory:false },
      { path:'emulators/wdosbox.js',   url:'emulators/wdosbox.js',   required:false, keepInMemory:false },
      { path:'TASM.EXE',     url:'tools/TASM.EXE',     required:true,  keepInMemory:true },
      { path:'TLINK.EXE',    url:'tools/TLINK.EXE',    required:true,  keepInMemory:true },
      { path:'DPMI16BI.OVL', url:'tools/DPMI16BI.OVL', required:false, keepInMemory:true },
      { path:'RTM.EXE',      url:'tools/RTM.EXE',      required:false, keepInMemory:true },
      { path:'TD.EXE',       url:'tools/TD.EXE',       required:false, keepInMemory:true },
      { path:'TDCONFIG.TD',  url:'tools/TDCONFIG.TD',  required:false, keepInMemory:true },
    ];
    const cache = await caches.open(CACHE_NAME);
    const mem = new Map();

    let total = files.length, done = 0;
    prog.max = total; prog.value = 0; progText.textContent = `0/${total}`;

    for (const f of files) {
      const hit = await cache.match(f.url);
      if (hit) {
        done++; prog.value = done; progText.textContent = `${done}/${total}`;
        if (f.keepInMemory) {
          const buf = new Uint8Array(await hit.clone().arrayBuffer());
          mem.set(f.path, buf);
        }
      }
    }
    for (const f of files) {
      const hit = await cache.match(f.url);
      if (hit) continue;
      const resp = await fetch(new Request(f.url, { cache:'reload' })).catch(()=>null);
      if (!resp || !resp.ok) {
        if (f.required) throw new Error('Network error loading ' + f.url);
      } else {
        cache.put(f.url, resp.clone()).catch(()=>{});
        if (f.keepInMemory) {
          const buf = new Uint8Array(await resp.clone().arrayBuffer());
          mem.set(f.path, buf);
        }
      }
      done++; prog.value = done; progText.textContent = `${done}/${total}`;
    }
    for (const f of files) {
      if (!f.keepInMemory || mem.has(f.path)) continue;
      const hit = await cache.match(f.url);
      if (hit) {
        const buf = new Uint8Array(await hit.clone().arrayBuffer());
        mem.set(f.path, buf);
      }
    }
    toolBufs = new Map();
    for (const [k,v] of mem.entries()) toolBufs.set(k.split('/').pop(), v);

    // Hide loading once ready & enable Start
    loadingBox.style.display = 'none';
    ready = true;
    startBtn.disabled = false;
  }

  // Editor actions
  saveBtn.addEventListener('click', ()=>{
    const name = toDos83(fileNameEl.value || 'HELLO.ASM');
    const blob = new Blob([cm.getValue()], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  loadBtn.addEventListener('click', ()=> loader.click());
  loader.addEventListener('change', async ()=>{
    const f = loader.files && loader.files[0];
    if (!f) return;
    const txt = await f.text();
    cm.setValue(txt);
    fileNameEl.value = toDos83(f.name);
    loader.value = '';
    cm.refresh();
    cm.focus();
  });

  // Assets (now located in the top workspace too)
  elInput.addEventListener('change', ()=>{
    for (const f of Array.from(elInput.files || [])) bag.set(f.name, f);
    refreshFileList();
    elInput.value = '';
  });

  // Start
  startBtn.addEventListener('click', async ()=>{
    try {
      const nameRaw = (fileNameEl.value || 'HELLO.ASM').trim();
      // Persist editor state
      localStorage.setItem(LS_KEY_NAME, nameRaw);
      localStorage.setItem(LS_KEY_TEXT, cm.getValue());

      // Grey-out editor and disable Start
      cm.setOption('readOnly', true);
      workspace.classList.add('cm-locked');
      startBtn.disabled = true;
      startBtn.classList.add('disabled');

      const dosAsmName = toDos83(nameRaw);
      const asmBytes = encoder.encode(cm.getValue());

      const initFs = [
        { path: 'TASM.EXE',  contents: toolBufs.get('TASM.EXE') },
        { path: 'TLINK.EXE', contents: toolBufs.get('TLINK.EXE') },
        { path: dosAsmName,  contents: asmBytes },
        { path: 'BUILD.BAT', contents: buildBatFor(dosAsmName) },
      ];
      for (const p of ['DPMI16BI.OVL','RTM.EXE','TD.EXE','TDCONFIG.TD']) {
        const buf = toolBufs.get(p); if (buf) initFs.push({ path: p, contents: buf });
      }
      for (const f of Array.from(bag.values())) {
        const buf = new Uint8Array(await f.arrayBuffer());
        initFs.push({ path: toDos83(f.name), contents: buf });
      }

      startDosWith(initFs);

      // Smooth-scroll to the DOSBox section after kicking it off
      setTimeout(()=> {
        emuSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    } catch (e) {
      console.error(e);
      alert('Could not start emulator. See console.');
    }
  });

  // Stop: scroll to top, then reload
  stopBtn.addEventListener('click', ()=>{
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(()=>location.reload(), 250);
  });

  // Boot
  (async ()=>{
    await waitForCOIController().catch(()=>{});
    try { await preloadAll(); }
    catch (e) { status.textContent = 'Preload failed. Try hard-refresh.'; console.error(e); }
  })();
})();
</script>
</body>
</html>
