<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>8086 Assembly Runner (TASM/TLINK, js-dos CDN)</title>

  <!-- js-dos v8 CDN -->
  <link rel="stylesheet" href="https://v8.js-dos.com/latest/js-dos.css">
  <script src="https://v8.js-dos.com/latest/js-dos.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .row { display: grid; grid-template-columns: 1fr 520px; gap: 16px; align-items: start; }
    textarea { width: 100%; height: 520px; font-family: Consolas, Menlo, monospace; font-size: 14px; }
    #dosbox { width: 520px; height: 400px; border: 1px solid #ccc; }
    #runBtn { padding: 8px 14px; font-size: 16px; }
    .bar { display:flex; gap:8px; align-items:center; margin:8px 0 0; }
    .small { color:#666; font-size: 12px; }
    h1 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>8086 Assembly Runner</h1>
  <p class="small">
    Paste TASM-style source (<code>.model small</code> etc.), click <b>Run</b>. All build messages and program I/O appear in the DOS screen.
    Your code is saved locally (browser) every time you press Run.
  </p>

  <div class="row">
    <div>
      <textarea id="code"></textarea>
      <div class="bar">
        <button id="runBtn">Run</button>
        <span id="status" class="small"></span>
      </div>
    </div>

    <div>
      <div id="dosbox"></div>
      <p class="small">Tip: the DOS screen shows both TASM/TLINK diagnostics and your program output.</p>
    </div>
  </div>

  <script>
  // Prevent duplicate initialization if this script is included twice by the site template
  if (!window.__asmRunnerInit__) {
    window.__asmRunnerInit__ = true;

    // Use js-dos CDN core
    const WDO_URL = "https://v8.js-dos.com/latest/wdosbox.js";

    const elCode  = document.getElementById('code');
    const elRun   = document.getElementById('runBtn');
    const elStat  = document.getElementById('status');
    const elDos   = document.getElementById('dosbox');

    const LS_KEY = "asm-editor-text-v1";
    const encoder = new TextEncoder();

    // Starter code (students can overwrite)
    const DEFAULT_SRC = [
      "; Sample TASM program (EXE) for 8086",
      ".model small",
      ".stack 100h",
      ".data",
      "msg db 'Hello from TASM in the browser!$'",
      ".code",
      "main proc",
      "    mov ax, @data",
      "    mov ds, ax",
      "    mov dx, offset msg",
      "    mov ah, 9",
      "    int 21h",
      "    mov ax, 4C00h",
      "    int 21h",
      "main endp",
      "end main"
    ].join("\n");

    elCode.value = localStorage.getItem(LS_KEY) || DEFAULT_SRC;

    // Preload TASM/TLINK from your repo (tools/)
    let tasmBuf = null, tlinkBuf = null;
    async function preloadTools() {
      const [tasm, tlink] = await Promise.all([
        fetch("tools/TASM.EXE").then(r => {
          if (!r.ok) throw new Error("TASM.EXE not found");
          return r.arrayBuffer();
        }),
        fetch("tools/TLINK.EXE").then(r => {
          if (!r.ok) throw new Error("TLINK.EXE not found");
          return r.arrayBuffer();
        })
      ]);
      tasmBuf  = new Uint8Array(tasm);
      tlinkBuf = new Uint8Array(tlink);
    }

    // DOSBox config:
    // NOTE: mount and drive switch must be in [autoexec], not [dos].
    const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
echo js-dos (TASM/TLINK) ready
BUILD
`;

    // Command interface holder (kept on window to avoid redeclaration if script runs twice)
    window._dosCi = window._dosCi || null;

    // Launch a fresh js-dos instance
    function startDosWith(initFs) {
      elDos.innerHTML = ""; // reset container
      return new Promise((resolve) => {
        Dos(elDos, {
          wdosboxUrl: WDO_URL,
          dosboxConf: DOS_CONF,
          initFs,
          onEvent: (event, payload) => {
            if (event === "ci-ready") {
              window._dosCi = payload;
              resolve();
            }
          }
        });
      });
    }

    // BUILD.BAT for TASM/TLINK:
    // - Assemble MAIN.ASM quietly to reduce prompts
    // - On error, echo log and stop
    // - On success, link then run MAIN.EXE
    function buildBat() {
      return encoder.encode([
        "@echo off",
        "echo Assembling MAIN.ASM (TASM)...",
        "TASM /q MAIN.ASM > BUILD.LOG",
        "if errorlevel 1 goto ERR",
        "echo Linking MAIN.OBJ (TLINK)...",
        "TLINK MAIN.OBJ,,NUL,; >> BUILD.LOG",
        "if errorlevel 1 goto ERR",
        "echo Running MAIN.EXE...",
        "MAIN.EXE",
        "goto END",
        ":ERR",
        "echo.",
        "echo ===== BUILD FAILED =====",
        "type BUILD.LOG",
        ":END",
        "echo.",
        "echo ===== DONE ====="
      ].join("\r\n"));
    }

    // Run button handler
    elRun.addEventListener('click', async () => {
      try {
        elRun.disabled = true;
        elStat.textContent = "Preparing...";

        if (!tasmBuf || !tlinkBuf) {
          await preloadTools();
        }

        // Save editor text for persistence
        const code = elCode.value || "";
        localStorage.setItem(LS_KEY, code);

        // Files to inject into C:\
        const initFs = [
          { path: "TASM.EXE",  contents: tasmBuf },
          { path: "TLINK.EXE", contents: tlinkBuf },
          { path: "MAIN.ASM",  contents: encoder.encode(code) },
          { path: "BUILD.BAT", contents: buildBat() }
        ];

        await startDosWith(initFs);
        elStat.textContent = "Running in DOS...";
      } catch (e) {
        console.error(e);
        elStat.textContent = "Error: " + (e?.message || e);
      } finally {
        elRun.disabled = false;
      }
    });

    // Optional: auto-run once on load
    // window.addEventListener('load', () => elRun.click());
  }
  </script>
</body>
</html>
