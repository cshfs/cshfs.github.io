<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>8086 Assembly Runner â€” Minimal</title>

  <!-- js-dos v8 CDN -->
  <link rel="stylesheet" href="https://v8.js-dos.com/latest/js-dos.css">
  <script src="https://v8.js-dos.com/latest/js-dos.js"></script>

  <style>
    :root { --w: 800px; --h: 600px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; min-height: 100dvh; display: grid; place-items: center; background: #f7f7f9; }
    .wrap { width: 100%; max-width: calc(var(--w) + 32px); padding: 16px; }
    .center { display: grid; justify-items: center; gap: 12px; }
    #dosbox { width: var(--w); height: var(--h); border: 1px solid #ddd; background: #000; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,.08); }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="file"]{ padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 10px 16px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; font-size: 15px; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .status { min-height: 18px; font-size: 12px; color:#666; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="center">
      <div id="dosbox"></div>
      <div class="bar">
        <input id="fileInput" type="file" multiple />
        <button id="runBtn">Run</button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
  if (!window.__asmRunnerMinimal__) {
    window.__asmRunnerMinimal__ = true;

    const elDos   = document.getElementById('dosbox');
    const elRun   = document.getElementById('runBtn');
    const elInput = document.getElementById('fileInput');
    const elStat  = document.getElementById('status');

    const encoder = new TextEncoder();

    // Helper: map to DOS 8.3
    function toDos83(name) {
      const idx = name.lastIndexOf('.');
      let base = (idx >= 0 ? name.slice(0, idx) : name).toUpperCase();
      let ext  = (idx >= 0 ? name.slice(idx + 1) : '').toUpperCase();
      const clean = s => s.replace(/[^A-Z0-9]/g, '_');
      base = clean(base).slice(0, 8);
      ext  = clean(ext).slice(0, 3);
      return ext ? `${base}.${ext}` : base;
    }

    // Toolchain prefetch
    let tasmBuf = null, tlinkBuf = null, dpmiBuf = null, rtmBuf = null;
    async function preloadTools() {
      const get = async (path, opt = false) => {
        const r = await fetch(path);
        if (!r.ok) { if (opt) return null; throw new Error(path + ' not found'); }
        return new Uint8Array(await r.arrayBuffer());
      };
      [tasmBuf, tlinkBuf, dpmiBuf, rtmBuf] = await Promise.all([
        get('tools/TASM.EXE'),
        get('tools/TLINK.EXE'),
        get('tools/DPMI16BI.OVL', true),
        get('tools/RTM.EXE', true)
      ]);
    }

    const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
echo js-dos (TASM/TLINK) ready
BUILD
`;

    function buildBat() {
      return encoder.encode([
        '@echo off',
        'echo Assembling MAIN.ASM (TASM)...',
        'TASM /q MAIN.ASM > BUILD.LOG',
        'if errorlevel 1 goto ERR',
        'echo Linking MAIN.OBJ (TLINK)...',
        'TLINK MAIN.OBJ,,NUL,; >> BUILD.LOG',
        'if errorlevel 1 goto ERR',
        'echo Running MAIN.EXE...',
        'MAIN.EXE',
        'goto END',
        ':ERR',
        'echo.',
        'echo ===== BUILD FAILED =====',
        'type BUILD.LOG',
        ':END',
        'echo.',
        'echo ===== DONE ====='
      ].join('\r\n'));
    }

    function startDosWith(initFs) {
      elDos.innerHTML = '';
      return new Promise((resolve) => {
        Dos(elDos, {
          wdosboxUrl: 'https://v8.js-dos.com/latest/wdosbox.js',
          dosboxConf: DOS_CONF,
          initFs,
          onEvent: (ev) => { if (ev === 'ci-ready') resolve(); }
        });
      });
    }

    async function filesToInitFs(fileList) {
      // Validate exactly one .asm file
      const files = Array.from(fileList || []);
      const asmFiles = files.filter(f => /\.(asm)$/i.test(f.name));
      if (asmFiles.length !== 1) {
        throw new Error('Select exactly ONE .asm file (other files allowed too).');
      }

      // Read ASM text and other file bytes
      const asmText = await asmFiles[0].text();

      const initFs = [
        { path: 'TASM.EXE',  contents: tasmBuf },
        { path: 'TLINK.EXE', contents: tlinkBuf },
        { path: 'MAIN.ASM',  contents: encoder.encode(asmText) },
        { path: 'BUILD.BAT', contents: buildBat() }
      ];
      if (dpmiBuf) initFs.push({ path: 'DPMI16BI.OVL', contents: dpmiBuf });
      if (rtmBuf)  initFs.push({ path: 'RTM.EXE',      contents: rtmBuf  });

      for (const f of files) {
        if (f === asmFiles[0]) continue; // ASM already mapped to MAIN.ASM
        const dos = toDos83(f.name);
        const buf = new Uint8Array(await f.arrayBuffer());
        initFs.push({ path: dos, contents: buf });
      }
      return initFs;
    }

    elRun.addEventListener('click', async () => {
      try {
        elRun.disabled = true;
        elStat.textContent = 'Preparing...';
        if (!tasmBuf || !tlinkBuf) await preloadTools();
        const initFs = await filesToInitFs(elInput.files);
        elStat.textContent = 'Starting DOS...';
        await startDosWith(initFs);
        elStat.textContent = 'Running...';
      } catch (e) {
        alert(e && e.message ? e.message : String(e));
        elStat.textContent = '';
      } finally {
        elRun.disabled = false;
      }
    });

    // Immediate validation feedback on selection
    elInput.addEventListener('change', () => {
      const files = Array.from(elInput.files || []);
      const asmCount = files.filter(f => /\.(asm)$/i.test(f.name)).length;
      if (asmCount === 0) {
        elStat.textContent = 'Select one .asm file (you can add assets too).';
      } else if (asmCount === 1) {
        elStat.textContent = files.length > 1 ? '1 ASM + ' + (files.length - 1) + ' asset(s) selected.' : '1 ASM selected.';
      } else {
        elStat.textContent = 'Too many ASM files selected.';
      }
    });
  }
  </script>
</body>
</html>
