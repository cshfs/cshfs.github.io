<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DOSBox — Editor + Run</title>

<!-- js-dos (local in /dosbox) -->
<link rel="stylesheet" href="js-dos.css" />
<script src="js-dos.js"></script>

<!-- CodeMirror 5 (local) -->
<link rel="stylesheet" href="codemirror.min.css">
<script src="codemirror.min.js"></script>

<!-- TASM mode -->
<script src="tasm.js"></script>

<style>
  :root{
    --ctl-h: 28px;
    --ctl-font: 12px;
    --overlay-z: 99999;
  }

  *{ box-sizing:border-box; }

  html, body { height:100%; background:#fff !important; color:#000; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow-x:hidden; /* hard stop for any accidental horizontal overflow */
  }

  main{
    width: min(1280px, 95vw);
    margin: 0 auto;
    padding: 10px;
  }

  section{ margin: 10px 0; }

  /* Full-screen preload overlay */
  #loadingOverlay{
    position:fixed; inset:0; z-index:var(--overlay-z);
    display:flex; align-items:center; justify-content:center;
    background:#fff;
  }
  #loadingCard{
    width:min(560px, 90vw);
    border:2px solid #000;
    padding:18px;
    background:#fff;
    color:#000;
  }
  #loadingTitle{ margin:0 0 8px 0; font-size:18px; }
  #status{ font-size:13px; margin:6px 0 10px 0; }
  progress{ width:100%; height:12px; vertical-align:middle; }
  #metaRow{ display:flex; justify-content:space-between; font-size:12px; margin-top:6px; color:#333; }
  .spinnerWrap{ display:flex; align-items:center; gap:12px; margin:10px 0 2px; }
  .spinner{
    width:18px; height:18px;
    border:2px solid #000; border-right-color:transparent;
    border-radius:50%;
    animation:spin .9s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* Controls row */
  .row{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    font: inherit;
    font-size: var(--ctl-font) !important;
    height: var(--ctl-h) !important;
    padding: 0 10px !important;
    border:2px solid #000 !important;
    border-radius:0 !important;
    background:#fff !important;
    color:#000 !important;
    cursor:pointer;
    min-height:0 !important;
  }
  .btn:hover{ background:#f4f4f4 !important; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }

  #fileName,
  .sel{
    -webkit-appearance:none; appearance:none;
    font: inherit;
    font-size: var(--ctl-font) !important;
    height: var(--ctl-h) !important;
    padding:0 10px !important;
    border:2px solid #000 !important;
    border-radius:0 !important;
    background:#fff;
    color:#000;
    min-height:0 !important;
  }
  #fileName{ width:260px; }
  .sel{ width:220px; }

  label.file{ position:relative; }
  label.file input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

  /* Editor: no JS sizing — stable and predictable */
  .CodeMirror{
    width:100%;
    border:2px solid #000;
    height: clamp(260px, 55vh, 680px);
  }
  .CodeMirror-gutters{ border-right:2px solid #000; }
  .cm-locked .CodeMirror{ opacity:.5; pointer-events:none; }

  /* Emulator hidden until Start */
  #emuSection{ display:none; }

  /* DOSBox frame: CSS-only sizing */
  #dosbox{
    border:2px solid #000;
    width:100%;
    height: clamp(260px, 60vh, 720px);
    overflow:hidden;       /* prevents any canvas overflow from showing */
    background:#fff !important;
  }
  #dosbox canvas{
    width:100% !important;
    height:100% !important;
    display:block;
    background:#000 !important;
  }

  /* Force js-dos wrappers to white */
  :where(.dosbox-root,.dosbox-container,.dosbox-viewport,.dosbox-overlay,.dosbox-loader,.dosbox){
    background:#fff !important;
    box-shadow:none !important;
    border-color:#fff !important;
  }

  /* Notepad++-like TASM colors */
  .cm-builtin       { color:#0070C0; }
  .cm-variable-2    { color:#0070C0; }
  .cm-tasm-directive{ color:#7A3E9D; }
  .cm-tasm-label    { color:#7A3E9D; font-weight:600; }
  .cm-keyword       { color:#0000FF; }
  .cm-atom          { color:#008080; font-style:italic; }
  .cm-number        { color:#C05000; }
  .cm-comment       { color:#008000; }
  .cm-string        { color:#A31515; }
</style>

<script>
/* COOP/COEP SW */
(function () {
  if (!('serviceWorker' in navigator)) return;
  const swUrl = new URL('./coi-sw.js', location.href);
  const KEY = 'coi-reloaded-once';
  navigator.serviceWorker.register(swUrl, { scope: './' }).then(async () => {
    if (!navigator.serviceWorker.controller && !sessionStorage.getItem(KEY)) {
      try { await navigator.serviceWorker.ready; sessionStorage.setItem(KEY,'1'); location.reload(); } catch {}
    }
  });
  navigator.serviceWorker.addEventListener('controllerchange', () => { sessionStorage.removeItem(KEY); });
})();
</script>
</head>

<body>

<!-- Full-screen preload overlay -->
<div id="loadingOverlay" aria-live="polite">
  <div id="loadingCard">
    <h2 id="loadingTitle">Preparing DOS environment…</h2>
    <div class="spinnerWrap">
      <div class="spinner" aria-hidden="true"></div>
      <div id="status">Initializing…</div>
    </div>
    <progress id="prog" value="0" max="100"></progress>
    <div id="metaRow">
      <div id="progText">0/0</div>
      <div id="coiNote"></div>
    </div>
  </div>
</div>

<main>
  <section id="workspace">
    <div class="row" id="nameRow">
      <input id="fileName" type="text" value="base.asm" aria-label="File name">
      <button id="newBtn" class="btn" type="button">New file</button>
      <button id="saveLocalBtn" class="btn" type="button">Save</button>
      <button id="saveBtn" class="btn" type="button">Download .ASM</button>
      <button id="loadBtn" class="btn" type="button">Load .ASM</button>
      <input id="loader" type="file" accept=".asm,.inc,.txt" style="display:none" />
      <label class="file btn">Choose asset files<input id="fileInput" type="file" multiple /></label>

      <select id="recentSel" class="sel" aria-label="Open recent">
        <option value="">Open recent…</option>
      </select>

      <button id="startBtn" class="btn" type="button" disabled>Start</button>
    </div>

    <textarea id="editorTA">IDEAL
MODEL small
STACK 100h
DATASEG
; --------------------------
; Your variables here
; --------------------------
msg db 'Hello!$'

CODESEG
start:
  mov ax, @data
  mov ds, ax
; --------------------------
; Your code here
; --------------------------
  call printHello


exit:
  mov ax, 4c00h
  int 21h

; --------------------------
; Your procedures here
; --------------------------
Proc printHello
  mov dx, OFFSET msg
  mov ah, 09h
  int 21h
  mov ax, 4C00h
  int 21h
  ret
endp

END start
</textarea>
  </section>

  <section id="emuSection">
    <div id="dosbox" aria-label="DOSBox frame"></div>
    <div class="row" style="margin-top:8px;">
      <button id="stopBtn" class="btn" type="button">Stop</button>
    </div>
  </section>
</main>

<script>
(function(){
  /* ===== Defaults ===== */
  const DEFAULT_BASE_NAME = 'base.asm';
  const DEFAULT_BASE_TEXT =
`IDEAL
MODEL small
STACK 100h
DATASEG
; --------------------------
; Your variables here
; --------------------------


CODESEG
start:
  mov ax, @data
  mov ds, ax
; --------------------------
; Your code here
; --------------------------

exit:
  mov ax, 4c00h
  int 21h
END start
`;

  /* ===== Persistence keys ===== */
  const LS_KEY_NAME    = 'dos_editor_name_v1';
  const LS_KEY_TEXT    = 'dos_editor_text_v1';
  const LS_KEY_RECENTS = 'dos_editor_recents_v1'; // [{name,text,t}, ...] up to 5

  /* ===== CodeMirror ===== */
  const cm = CodeMirror.fromTextArea(document.getElementById('editorTA'), {
    lineNumbers: true,
    mode: 'tasm',
    indentUnit: 2,
    tabSize: 2
  });

  /* ===== Elements ===== */
  const workspace   = document.getElementById('workspace');
  const emuSection  = document.getElementById('emuSection');
  const fileNameEl  = document.getElementById('fileName');
  const recentSel   = document.getElementById('recentSel');

  const newBtn      = document.getElementById('newBtn');
  const saveLocalBtn= document.getElementById('saveLocalBtn');
  const saveBtn     = document.getElementById('saveBtn');
  const loadBtn     = document.getElementById('loadBtn');
  const loader      = document.getElementById('loader');
  const elInput     = document.getElementById('fileInput');
  const startBtn    = document.getElementById('startBtn');
  const stopBtn     = document.getElementById('stopBtn');

  const overlay     = document.getElementById('loadingOverlay');
  const status      = document.getElementById('status');
  const prog        = document.getElementById('prog');
  const progText    = document.getElementById('progText');
  const coiNote     = document.getElementById('coiNote');

  /* ===== Recents ===== */
  function loadRecents(){
    try {
      const arr = JSON.parse(localStorage.getItem(LS_KEY_RECENTS) || '[]');
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function updateRecentUI(){
    const arr = loadRecents();
    recentSel.innerHTML = '<option value="">Open recent…</option>';
    arr.forEach((r, i) => {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = r.name;
      recentSel.appendChild(opt);
    });
  }
  function saveRecents(arr){
    localStorage.setItem(LS_KEY_RECENTS, JSON.stringify(arr.slice(0,5)));
    updateRecentUI();
  }
  function addRecent(name, text){
    const trimmed = (name || '').trim();
    if (!trimmed) return;
    let arr = loadRecents().filter(r => r && r.name !== trimmed);
    arr.unshift({ name: trimmed, text: String(text ?? ''), t: Date.now() });
    saveRecents(arr);
  }

  /* ===== Restore saved name/text ===== */
  const savedName = localStorage.getItem(LS_KEY_NAME);
  const savedText = localStorage.getItem(LS_KEY_TEXT);
  if (savedName) fileNameEl.value = savedName;
  if (savedText) cm.setValue(savedText);

  function persistNow(){
    localStorage.setItem(LS_KEY_NAME, fileNameEl.value || DEFAULT_BASE_NAME);
    localStorage.setItem(LS_KEY_TEXT, cm.getValue());
  }
  fileNameEl.addEventListener('input', persistNow);
  cm.on('change', () => { clearTimeout(persistNow._t); persistNow._t = setTimeout(persistNow, 120); });

  function autoDetectTasm(filename){
    cm.setOption("mode", filename.toLowerCase().endsWith(".asm") ? "tasm" : null);
  }
  fileNameEl.addEventListener('input', () => autoDetectTasm(fileNameEl.value));
  autoDetectTasm(fileNameEl.value);

  recentSel.addEventListener('change', () => {
    const val = recentSel.value;
    if (val === '') return;
    const idx = Number(val);
    const arr = loadRecents();
    const rec = arr[idx];
    if (!rec) { recentSel.value = ''; return; }
    cm.setValue(rec.text);
    fileNameEl.value = rec.name;
    autoDetectTasm(rec.name);
    cm.focus();
    persistNow();
    recentSel.value = '';
  });

  /* ===== Helpers ===== */
  const encoder = new TextEncoder();

  function toDos83(name){
    const i = name.lastIndexOf('.');
    let b = (i>=0?name.slice(0,i):name).toUpperCase();
    let e = (i>=0?name.slice(i+1):'').toUpperCase();
    const clean = s=>s.replace(/[^A-Z0-9]/g,'_');
    b = clean(b).slice(0,8);
    e = clean(e).slice(0,3);
    return e ? `${b}.${e}` : b;
  }

  const DOS_CONF = `
[sdl]
fullscreen=false

[autoexec]
@echo off
mount c .
c:
cls
BUILD
`;

  function buildBatFor(dosAsmName){
    const base = dosAsmName.replace(/\.[^.]*$/,'');
    const lines = [
      '@echo off',
      'echo Assembling ' + dosAsmName,
      'TASM /zi /q ' + dosAsmName,
      'if errorlevel 1 goto ERR',
      'echo Linking ' + base + '.OBJ',
      'TLINK /v ' + base + '.OBJ,,NUL,;',
      'if errorlevel 1 goto ERR',
      'echo Running ' + base + '.EXE',
      base + '.EXE',
      'echo.',
      'goto END',
      ':ERR',
      'echo Build failed.',
      ':END'
    ];
    return encoder.encode(lines.join("\r\n") + "\r\n");
  }

  /* ===== Files/tools ===== */
  let toolBufs = new Map();
  const bag = new Map();
  let player = null;

  function startDosWith(initFs){
    if (player && typeof player.exit === 'function') { try { player.exit(); } catch {} }
    const el = document.getElementById('dosbox');
    el.innerHTML = '';
    player = window.Dos(el, {
      pathPrefix: "emulators/",
      dosboxConf: DOS_CONF,
      initFs,
      noCloud: true,
      noNetworking: true,
      kiosk: true,
      autostart: true
    });
  }

  /* ===== UI actions ===== */
  newBtn.addEventListener('click', ()=>{
    fileNameEl.value = DEFAULT_BASE_NAME;
    cm.setValue(DEFAULT_BASE_TEXT);
    autoDetectTasm(DEFAULT_BASE_NAME);
    cm.focus();
    persistNow();
  });

  saveLocalBtn.addEventListener('click', ()=>{
    const name = fileNameEl.value || DEFAULT_BASE_NAME;
    const content = cm.getValue();
    persistNow();
    addRecent(name, content);
  });

  saveBtn.addEventListener('click', ()=>{
    const name = (fileNameEl.value || DEFAULT_BASE_NAME);
    const content = cm.getValue();
    const blob = new Blob([content], { type:'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name.toUpperCase();
    a.click();
    URL.revokeObjectURL(a.href);
    persistNow();
    addRecent(name, content);
  });

  loadBtn.addEventListener('click', ()=> loader.click());
  loader.addEventListener('change', async ()=>{
    const f = loader.files && loader.files[0];
    if (!f) return;
    const text = await f.text();
    cm.setValue(text);
    fileNameEl.value = f.name;
    autoDetectTasm(f.name);
    loader.value = '';
    cm.focus();
    persistNow();
    addRecent(f.name, text);
  });

  elInput.addEventListener('change', ()=>{
    for (const f of Array.from(elInput.files || [])) bag.set(f.name, f);
    elInput.value = '';
  });

  startBtn.addEventListener('click', async ()=>{
    try {
      const name = fileNameEl.value || DEFAULT_BASE_NAME;
      const content = cm.getValue();

      persistNow();
      addRecent(name, content);

      cm.setOption('readOnly', true);
      workspace.classList.add('cm-locked');
      startBtn.disabled = true;

      emuSection.style.display = 'block';

      const dosAsmName = toDos83(name);
      const asmBytes = encoder.encode(content);

      const initFs = [
        { path:'TASM.EXE',  contents: toolBufs.get('TASM.EXE') },
        { path:'TLINK.EXE', contents: toolBufs.get('TLINK.EXE') },
        { path:dosAsmName,  contents: asmBytes },
        { path:'BUILD.BAT', contents: buildBatFor(dosAsmName) },
      ];

      for (const p of ['DPMI16BI.OVL','RTM.EXE','TD.EXE','TDCONFIG.TD']) {
        const buf = toolBufs.get(p);
        if (buf) initFs.push({ path:p, contents:buf });
      }

      for (const f of Array.from(bag.values())) {
        initFs.push({ path: toDos83(f.name), contents: new Uint8Array(await f.arrayBuffer()) });
      }

      startDosWith(initFs);
      document.getElementById('dosbox').scrollIntoView({ behavior:'smooth', block:'start' });

    } catch (e) {
      console.error(e);
      alert('Start failed. See console.');
      startBtn.disabled = false;
      cm.setOption('readOnly', false);
      workspace.classList.remove('cm-locked');
    }
  });

  stopBtn.addEventListener('click', ()=>{
    if (player && typeof player.exit === 'function') { try { player.exit(); } catch {} }
    location.reload();
  });

  /* ===== Preload + overlay ===== */
  async function preloadAll(){
    status.textContent = 'Caching emulator and tools…';
    const files = [
      { path:'emulators/wdosbox.wasm', url:'emulators/wdosbox.wasm', required:true,  keepInMemory:false },
      { path:'emulators/wdosbox.js',   url:'emulators/wdosbox.js',   required:false, keepInMemory:false },
      { path:'TASM.EXE',     url:'tools/TASM.EXE',     required:true,  keepInMemory:true },
      { path:'TLINK.EXE',    url:'tools/TLINK.EXE',    required:true,  keepInMemory:true },
      { path:'DPMI16BI.OVL', url:'tools/DPMI16BI.OVL', required:false, keepInMemory:true },
      { path:'RTM.EXE',      url:'tools/RTM.EXE',      required:false, keepInMemory:true },
      { path:'TD.EXE',       url:'tools/TD.EXE',       required:false, keepInMemory:true },
      { path:'TDCONFIG.TD',  url:'tools/TDCONFIG.TD',  required:false, keepInMemory:true },
    ];

    const cache = await caches.open('dosbox-prewarm-v10');
    const mem = new Map();

    prog.max = files.length;
    prog.value = 0;
    progText.textContent = `0/${files.length}`;

    let done = 0;

    for (const f of files) {
      const hit = await cache.match(f.url);
      if (hit) {
        if (f.keepInMemory) mem.set(f.path.split('/').pop(), new Uint8Array(await hit.clone().arrayBuffer()));
        done++; prog.value = done; progText.textContent = `${done}/${files.length}`;
      }
    }

    for (const f of files) {
      if (await cache.match(f.url)) continue;
      status.textContent = `Downloading ${f.url.split('/').pop()}…`;
      const resp = await fetch(new Request(f.url, { cache:'reload' })).catch(()=>null);
      if (!resp || !resp.ok) {
        if (f.required) throw new Error('Network error ' + f.url);
      } else {
        cache.put(f.url, resp.clone()).catch(()=>{});
        if (f.keepInMemory) mem.set(f.path.split('/').pop(), new Uint8Array(await resp.clone().arrayBuffer()));
      }
      done++; prog.value = done; progText.textContent = `${done}/${files.length}`;
    }

    toolBufs = new Map(mem);

    startBtn.disabled = false;
    overlay.style.display = 'none';
    status.textContent = 'Ready';
  }

  (async ()=>{
    const t0 = performance.now();
    while (performance.now() - t0 < 8000) {
      if (navigator.serviceWorker?.controller && self.crossOriginIsolated) break;
      await new Promise(r=>setTimeout(r,120));
    }
    if (!(navigator.serviceWorker?.controller && self.crossOriginIsolated)) {
      coiNote.textContent = 'Tip: if Start fails, hard-refresh once.';
    }

    try { await preloadAll(); }
    catch (e) {
      status.textContent = 'Preload failed. Hard-refresh.';
      console.error(e);
    }

    updateRecentUI();
  })();

})();
</script>

</body>
</html>
